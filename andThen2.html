<script type="text/javascript">

var client = {
    put: function (options, callback) {
        return setTimeout(function() {callback('err', 'res')}, 1000);
    }
};

var AsyncChain = (function () {
    function AsyncChain(callback) {
        var context = {};
        
        return function (options) {
            var chain = function (context, asyncChain) {
                callback(options, function () {
                    if (asyncChain !== undefined) {
                        asyncChain(arguments, context);
                    }
                }, context);
            };
        
            return linkResult(chain);
        };
    }
    
    function Link(link, lastLink, options) {        
        var chain = function (context, asyncChain) {
            lastLink(context, function (previousResult, context) { 
                var result = link(previousResult, context);
                
                if (result !== undefined && result.err !== undefined) {
                    return result.err;
                }
                
                if (asyncChain !== undefined) {
                    asyncChain(result, context);
                }
            });
        };
        
        return linkResult(chain);
    }
    
    function linkResult(lastLink) {
        return {
            run: function (context) {
                if (context === undefined) {
                    context = {};
                }
                
                lastLink(context);
            },
            andThen: function (callback, options) {
                
                if (callback.asyncChain) {
                    console.log('woohoo');
                }
                else {console.log('oh');}
                
                return Link(function (previousResult, context) {
                    return callback(previousResult, options, context);
                }, lastLink, options);
            },
            asyncChain: true
        };
    }
    
    return AsyncChain;
})();

var handleClientResponse = function (result, options, context) {
    console.log('handling client response', result, options.hey, context);
    context.val2 = 'val2';
    return 1;
};

var printClientResponse = function (result, options, context) {
    console.log('printing client response', result, options.smeg, context);
};

var getClientResponse = AsyncChain(function (options, asyncChain, context) {
    console.log('getting client response', options.blah, context);
    context.val = 'val';
    client.put({}, asyncChain);
});

var getSecondResponse = AsyncChain(function (options, asyncChain, context) {
    console.log('getting second client response', options.blah, context);
    client.put({}, asyncChain);
})().andThen(function(result, options, context) {
    console.log('processing second response');
});

getClientResponse({blah: 'blah'})
    .andThen(handleClientResponse, {hey: 'hey'})
    .andThen(function (result, options, context) {
        console.log('some other stuff', result, options, context);
        context.val2 = 'val3';
        return {err:5};
    }, {ho: 'ho'})
    .andThen(printClientResponse, {smeg: 'smeg'})
    .run({start: 'start'});
    
// getClientResponse({blah: 'blah'})
//     .andThen(handleClientResponse, {hey: 'hey'})
//     .andThen(getSecondResponse)
//     .andThen(printClientResponse, {smeg: 'smeg'})
//     .run({start: 'start'});
    
console.log('Its Asynchronous!');

</script>