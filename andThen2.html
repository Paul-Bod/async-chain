<script type="text/javascript">

var client = {
    put: function (options, callback) {
        return setTimeout(function() {callback('err', '{"body": "some body"}')}, 1000);
    }
};

var AsyncChain = (function () {
    function AsyncChain(callback) {        
        return function (options) {
            var firstLink = function (context, asyncChain) {
                callback(options, function () {
                    if (asyncChain !== undefined) {
                        asyncChain(arguments, context);
                    }
                }, context);
            };
        
            return addControls(firstLink);
        };
    }
    
    function extendChain(link, previousLinks, options) {        
        return function (context, asyncChain) {
            previousLinks(context, function (previousResult, context) { 
                if (link.asyncChain) {
                    link.then(function (result, options, context) {asyncChain(result, context)}).run(context);
                    return { break: true };
                }
                                
                var result = link(previousResult, options, context);
                
                if (result !== undefined && result.break !== undefined) {
                    return result.break;
                }
                
                if (asyncChain !== undefined) {
                    asyncChain(result, context);
                }
            });
        };
    }
    
    function addControls(previousLinks) {
        return {
            run: function (context) {
                if (context === undefined) {
                    context = {};
                }
                
                previousLinks(context);
            },
            then: function (callback, options) {
                var newChain = extendChain(callback, previousLinks, options);
                return addControls(newChain);
            },
            asyncChain: true
        };
    }
    
    return AsyncChain;
})();

var getSomeData = AsyncChain(function (options, asyncChain, context) {
    client.put({}, asyncChain);
});

var parseData = function (result, options, context) {
    body = result[1];
    context.body = JSON.parse(body).body
};

var getSomeMoreData = AsyncChain(function (options, asyncChain, context) {
    client.put({}, asyncChain);
});

var parseMoreData = function(result, options, context) {
    context.message = 'some message';
};

var printResult = function (result, options, context) {
    console.log(context.body, context.message, context.anotherMessage);
    console.log(context);
};

var subApiCall = getSomeMoreData().then(parseMoreData);

var subSubApiCall = getSomeMoreData().then(function (result, options, context) {context.anotherMessage = 'another message';});
    
var apiCall = getSomeData({blah: 'blah'})
    .then(parseData, {hey: 'hey'})
    .then(subApiCall)
    .then(subSubApiCall)
    .then(printResult, {smeg: 'smeg'})

apiCall.run({start: 'start'});
    
console.log('Its Asynchronous!');

</script>